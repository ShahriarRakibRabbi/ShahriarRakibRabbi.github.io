<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Testimonials | My Portfolio</title>
    <meta name="description" content="Edit testimonials for my portfolio website">
    <meta name="robots" content="noindex, nofollow">
    <!-- Favicon -->
    <link rel="shortcut icon" href="../assets/images/favicon.ico" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <!-- Sortable.js -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Image Compressor -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.js"></script>
</head>
<body data-admin-page="testimonials" data-editor-type="testimonials">
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside id="admin-sidebar" class="admin-sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="sidebar-logo">
                    <i class="fas fa-code"></i>
                    <span>Portfolio Admin</span>
                </a>
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <ul>
                        <li>
                            <a href="dashboard.html" class="sidebar-item" data-page="dashboard">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="edit-projects.html" class="sidebar-item" data-page="projects">
                                <i class="fas fa-briefcase"></i>
                                <span>Projects</span>
                            </a>
                        </li>
                        <li>
                            <a href="edit-skills.html" class="sidebar-item" data-page="skills">
                                <i class="fas fa-code"></i>
                                <span>Skills</span>
                            </a>
                        </li>
                        <li>
                            <a href="edit-achievements.html" class="sidebar-item" data-page="achievements">
                                <i class="fas fa-trophy"></i>
                                <span>Achievements</span>
                            </a>
                        </li>
                        <li>
                            <a href="edit-gallery.html" class="sidebar-item" data-page="gallery">
                                <i class="fas fa-images"></i>
                                <span>Gallery</span>
                            </a>
                        </li>
                        <li>
                            <a href="edit-testimonials.html" class="sidebar-item" data-page="testimonials">
                                <i class="fas fa-comment-alt"></i>
                                <span>Testimonials</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="sidebar-section">
                    <h3 class="sidebar-heading">Settings</h3>
                    <ul>
                        <li>
                            <a href="#" class="sidebar-item" data-modal-target="github-settings-modal">
                                <i class="fab fa-github"></i>
                                <span>GitHub Integration</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-item" data-modal-target="backup-modal">
                                <i class="fas fa-cloud-download-alt"></i>
                                <span>Backup & Restore</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-item" data-modal-target="account-settings-modal">
                                <i class="fas fa-user-cog"></i>
                                <span>Account Settings</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <a href="../index.html" target="_blank" class="sidebar-footer-item">
                    <i class="fas fa-external-link-alt"></i>
                    <span>View Site</span>
                </a>
                <button id="logout-btn" class="sidebar-footer-item">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="admin-content" class="admin-content">
            <!-- Top Bar -->
            <header class="admin-header">
                <div class="header-search">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-search" placeholder="Search testimonials...">
                    </div>
                    <div id="search-results" class="search-results hidden"></div>
                </div>
                
                <div class="header-actions">
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="notifications-dropdown">
                        <button id="notification-bell" class="notification-bell">
                            <i class="fas fa-bell"></i>
                            <span id="notification-count" class="notification-count hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="dropdown-menu notification-menu hidden"></div>
                    </div>
                    
                    <div class="user-dropdown">
                        <button id="user-menu-btn" class="user-menu-btn">
                            <img id="user-avatar" src="../assets/images/defaults/avatar.png" alt="Admin" class="user-avatar">
                            <span id="user-display-name">Admin</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="user-dropdown" class="dropdown-menu user-menu hidden">
                            <a href="#" class="dropdown-item" data-modal-target="account-settings-modal">
                                <i class="fas fa-user-circle"></i>
                                <span>My Account</span>
                            </a>
                            <a href="#" class="dropdown-item" data-modal-target="security-settings-modal">
                                <i class="fas fa-lock"></i>
                                <span>Security</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <button id="logout-menu-btn" class="dropdown-item">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="admin-page-content">
                <!-- Breadcrumbs -->
                <div class="breadcrumbs-wrapper">
                    <ul id="breadcrumbs" class="breadcrumbs">
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li>Edit Testimonials</li>
                    </ul>
                </div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-title">
                        <h1>
                            <i class="fas fa-comment-alt"></i>
                            Edit Testimonials
                        </h1>
                        <p class="page-subtitle">Manage client testimonials and feedback displayed on your portfolio</p>
                    </div>
                    
                    <div class="page-actions">
                        <button class="btn btn-primary add-item-btn" data-target="#testimonials-container">
                            <i class="fas fa-plus"></i> Add New Testimonial
                        </button>
                    </div>
                </div>

                <!-- GitHub Credentials Notice -->
                <div class="info-box info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <p>Changes will be saved to your GitHub repository. Make sure you've set up GitHub integration in the settings.</p>
                    </div>
                </div>
                
                <!-- Editor Form -->
                <div class="editor-container">
                    <form id="testimonials-editor" class="editor-form">
                        <div class="editor-toolbar">
                            <div class="toolbar-section">
                                <span class="last-updated" data-content-type="testimonials">Last updated: Loading...</span>
                            </div>
                            <div class="toolbar-actions">
                                <button type="button" class="btn btn-outline discard-changes-btn">
                                    <i class="fas fa-undo"></i> Discard Changes
                                </button>
                                <button type="button" class="btn btn-primary save-changes-btn">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                        
                        <!-- GitHub Commit Options -->
                        <div class="commit-options">
                            <div class="form-group">
                                <label for="commit-message">Commit Message</label>
                                <input type="text" id="commit-message" class="form-control" placeholder="Update testimonials" value="Update testimonials">
                            </div>
                        </div>

                        <!-- Testimonials Container -->
                        <div class="items-container">
                            <div class="content-header">
                                <h2>Testimonials</h2>
                                <div class="sort-options">
                                    <label for="sort-testimonials">Sort by:</label>
                                    <select id="sort-testimonials" class="form-control form-control-sm">
                                        <option value="rating-desc">Rating (High to Low)</option>
                                        <option value="rating-asc">Rating (Low to High)</option>
                                        <option value="date-desc">Date (Newest)</option>
                                        <option value="date-asc">Date (Oldest)</option>
                                        <option value="name-asc">Name (A-Z)</option>
                                        <option value="name-desc">Name (Z-A)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="testimonials-container" class="sortable-list">
                                <!-- Testimonial items will be added here dynamically -->
                                <div class="loading-container">
                                    <div class="loader"></div>
                                    <p>Loading testimonials...</p>
                                </div>
                            </div>
                            
                            <!-- Upload Progress Bars -->
                            <div class="upload-progress-container hidden">
                                <h3>Uploading Files</h3>
                                <div class="progress-bar-wrapper">
                                    <div class="upload-progress" data-index="0" style="width: 0%">0%</div>
                                </div>
                                <div class="progress-bar-wrapper">
                                    <div class="upload-progress" data-index="1" style="width: 0%">0%</div>
                                </div>
                                <div class="progress-bar-wrapper">
                                    <div class="upload-progress" data-index="2" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                                <!-- Preview Section -->
                                <div class="preview-section">
                                    <div class="preview-header">
                                        <h2>Preview</h2>
                                        <div class="preview-actions">
                                            <button type="button" class="btn btn-sm btn-outline refresh-preview-btn">
                                                <i class="fas fa-sync-alt"></i> Refresh Preview
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline toggle-preview-btn">
                                                <i class="fas fa-eye"></i> Hide Preview
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="preview-container">
                                        <div class="preview-wrapper">
                                            <div id="testimonials-preview" class="preview-content">
                                                <!-- Preview content will be generated here -->
                                                <div class="loading-container">
                                                    <div class="loader"></div>
                                                    <p>Generating preview...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Testimonial Templates Section -->
                                <div class="templates-section">
                                    <div class="templates-header">
                                        <h2>Testimonial Templates</h2>
                                        <button type="button" class="btn btn-sm btn-outline toggle-templates-btn">
                                            <i class="fas fa-chevron-down"></i> Show Templates
                                        </button>
                                    </div>
                                    
                                    <div class="templates-container hidden">
                                        <div class="template-card" data-template="standard">
                                            <div class="template-preview">
                                                <img src="../assets/images/admin/templates/testimonial-standard.jpg" alt="Standard Testimonial">
                                            </div>
                                            <div class="template-info">
                                                <h3>Standard Testimonial</h3>
                                                <p>Basic testimonial with quote, name, and role</p>
                                                <button type="button" class="btn btn-sm btn-outline use-template-btn">Use Template</button>
                                            </div>
                                        </div>
                                        
                                        <div class="template-card" data-template="detailed">
                                            <div class="template-preview">
                                                <img src="../assets/images/admin/templates/testimonial-detailed.jpg" alt="Detailed Testimonial">
                                            </div>
                                            <div class="template-info">
                                                <h3>Detailed Testimonial</h3>
                                                <p>Testimonial with project details and work relationship</p>
                                                <button type="button" class="btn btn-sm btn-outline use-template-btn">Use Template</button>
                                            </div>
                                        </div>
                                        
                                        <div class="template-card" data-template="video">
                                            <div class="template-preview">
                                                <img src="../assets/images/admin/templates/testimonial-video.jpg" alt="Video Testimonial">
                                            </div>
                                            <div class="template-info">
                                                <h3>Video Testimonial</h3>
                                                <p>Testimonial with embedded video content</p>
                                                <button type="button" class="btn btn-sm btn-outline use-template-btn">Use Template</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                    
                    <!-- Testimonial Item Template -->
                    <template id="testimonial-item-template">
                        <div class="item-wrapper testimonial-item" data-id="">
                            <div class="item-header">
                                <div class="drag-handle">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <h3 class="item-title">New Testimonial</h3>
                                <div class="item-actions">
                                    <button type="button" class="btn btn-sm item-action toggle-item" title="Collapse/Expand">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger item-action delete-item" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="item-content">
                                <!-- Client Info -->
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>Client Name</label>
                                        <input type="text" class="form-control testimonial-name" placeholder="John Doe" required>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label>Position/Company</label>
                                        <input type="text" class="form-control testimonial-position" placeholder="CEO at Company">
                                    </div>
                                </div>
                                
                                <!-- Avatar Upload -->
                                <div class="form-group">
                                    <label>Client Avatar</label>
                                    <div class="avatar-upload-container">
                                        <div class="avatar-preview">
                                            <img src="../assets/images/defaults/avatar.png" class="testimonial-avatar-preview" alt="Avatar Preview">
                                            <div class="avatar-overlay">
                                                <i class="fas fa-camera"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="avatar-controls">
                                            <div class="avatar-input-wrapper">
                                                <input type="file" class="testimonial-avatar-input" accept="image/*">
                                                <button type="button" class="btn btn-sm btn-outline avatar-upload-btn">
                                                    <i class="fas fa-upload"></i> Upload Image
                                                </button>
                                            </div>
                                            
                                            <div class="avatar-options">
                                                <button type="button" class="btn btn-sm btn-outline avatar-crop-btn" title="Crop Image">
                                                    <i class="fas fa-crop-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline avatar-remove-btn" title="Remove Image">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <input type="hidden" class="testimonial-avatar" value="">
                                    </div>
                                    
                                    <div class="avatar-info">
                                        <small class="form-text text-muted">
                                            Recommended size: 100x100px. Max file size: 500KB. Supported formats: JPG, PNG.
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Testimonial Content -->
                                <div class="form-group">
                                    <label>Testimonial Text</label>
                                    <textarea class="form-control testimonial-text" rows="4" placeholder="Enter the testimonial content here..." required></textarea>
                                </div>
                                
                                <!-- Rating -->
                                <div class="form-group">
                                    <label>Rating</label>
                                    <div class="rating-selector">
                                        <i class="fas fa-star rating-star" data-rating="1"></i>
                                        <i class="fas fa-star rating-star" data-rating="2"></i>
                                        <i class="fas fa-star rating-star" data-rating="3"></i>
                                        <i class="fas fa-star rating-star" data-rating="4"></i>
                                        <i class="fas fa-star rating-star" data-rating="5"></i>
                                        <input type="hidden" class="testimonial-rating" value="5">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>Project/Service</label>
                                        <input type="text" class="form-control testimonial-project" placeholder="Web Development">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label>Date</label>
                                        <input type="date" class="form-control testimonial-date">
                                    </div>
                                </div>
                                
                                <!-- Advanced Options -->
                                <div class="advanced-options">
                                    <div class="advanced-toggle">
                                        <span>Advanced Options</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    
                                    <div class="advanced-content hidden">
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Location</label>
                                                <input type="text" class="form-control testimonial-location" placeholder="New York, USA">
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>Social Profile</label>
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text"><i class="fab fa-linkedin"></i></span>
                                                    </div>
                                                    <input type="text" class="form-control testimonial-social" placeholder="LinkedIn profile URL">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group col-12">
                                                <label>Video Testimonial (optional)</label>
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text"><i class="fab fa-youtube"></i></span>
                                                    </div>
                                                    <input type="text" class="form-control testimonial-video" placeholder="YouTube or Vimeo URL">
                                                </div>
                                                <small class="form-text text-muted">Add a video testimonial from YouTube or Vimeo.</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <div class="checkbox-group">
                                                <input type="checkbox" class="testimonial-featured" id="testimonial-featured">
                                                <label for="testimonial-featured">Featured Testimonial</label>
                                            </div>
                                            <small class="form-text text-muted">Featured testimonials are highlighted on your portfolio.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                
                    <!-- Image Crop Modal -->
                    <template id="image-crop-modal">
                        <div class="modal-header">
                            <h2>Crop Image</h2>
                            <button class="modal-close" aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="crop-container">
                                <img src="" id="crop-image" alt="Image to crop">
                            </div>
                            <div class="crop-preview">
                                <div class="preview-title">Preview</div>
                                <div class="preview-container">
                                    <div class="avatar-preview">
                                        <div id="crop-preview"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="crop-controls">
                                <button type="button" class="btn btn-sm btn-outline crop-zoom-in">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline crop-zoom-out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline crop-rotate">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline crop-reset">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="image-info">
                                <p>Drag to reposition. Use the controls to zoom and rotate.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline modal-close">Cancel</button>
                            <button id="apply-crop" class="btn btn-primary">Apply</button>
                        </div>
                    </template>
                    
                    <!-- Delete Confirmation Modal -->
                    <template id="delete-confirm-modal">
                        <div class="modal-header">
                            <h2>Delete Testimonial</h2>
                            <button class="modal-close" aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this testimonial? This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline modal-close">Cancel</button>
                            <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
                        </div>
                    </template>
                    
                    <!-- Discard Changes Modal -->
                    <template id="discard-changes-modal">
                        <div class="modal-header">
                            <h2>Discard Changes</h2>
                            <button class="modal-close" aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to discard all your changes? This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline modal-close">Cancel</button>
                            <button id="confirm-discard-btn" class="btn btn-warning">Discard Changes</button>
                        </div>
                    </template>
                
                    <!-- Modal Container -->
                    <div id="modal-container"></div>
                
                    <!-- Scripts -->
                    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
                    <script src="../assets/js/data-loader.js"></script>
                    <script src="../assets/js/auth.js"></script>
                    <script src="../assets/js/admin/main.js"></script>
                    <script src="../assets/js/admin/testimonials-editor.js"></script>
                    <script src="../assets/js/admin/image-upload.js"></script>
                    <script src="../assets/js/admin/notifications.js"></script>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Initialize testimonial editor
                            if (typeof TestimonialsEditor !== 'undefined') {
                                TestimonialsEditor.init();
                            }
                            
                            // Handle avatar upload click events
                            document.addEventListener('click', function(e) {
                                if (e.target.closest('.avatar-upload-btn')) {
                                    const wrapper = e.target.closest('.avatar-upload-container');
                                    if (wrapper) {
                                        const input = wrapper.querySelector('.testimonial-avatar-input');
                                        if (input) input.click();
                                    }
                                }
                                
                                if (e.target.closest('.avatar-preview')) {
                                    const wrapper = e.target.closest('.avatar-upload-container');
                                    if (wrapper) {
                                        const input = wrapper.querySelector('.testimonial-avatar-input');
                                        if (input) input.click();
                                    }
                                }
                            });
                            
                            // Handle file input changes for testimonial avatars
                            document.addEventListener('change', function(e) {
                                if (e.target.matches('.testimonial-avatar-input')) {
                                    const file = e.target.files[0];
                                    if (!file) return;
                                    
                                    // Validate file
                                    if (!file.type.match('image.*')) {
                                        NotificationModule.showError('Please select an image file (JPG, PNG)');
                                        return;
                                    }
                                    
                                    if (file.size > 500 * 1024) {
                                        NotificationModule.showError('Image is too large. Maximum size is 500KB');
                                        return;
                                    }
                                    
                                    // Get wrapper and preview elements
                                    const wrapper = e.target.closest('.avatar-upload-container');
                                    if (!wrapper) return;
                                    
                                    const previewImg = wrapper.querySelector('.testimonial-avatar-preview');
                                    if (!previewImg) return;
                                    
                                    // Open crop modal
                                    openCropModal(file, previewImg, function(croppedImage) {
                                        // Update the preview
                                        previewImg.src = croppedImage;
                                        
                                        // Update hidden input value
                                        const hiddenInput = wrapper.querySelector('.testimonial-avatar');
                                        if (hiddenInput) {
                                            hiddenInput.value = croppedImage;
                                        }
                                        
                                        // Show avatar options once image is loaded
                                        wrapper.classList.add('has-avatar');
                                    });
                                }
                            });
                            
                            // Handle avatar remove button
                            document.addEventListener('click', function(e) {
                                if (e.target.closest('.avatar-remove-btn')) {
                                    const wrapper = e.target.closest('.avatar-upload-container');
                                    if (!wrapper) return;
                                    
                                    // Reset preview to default avatar
                                    const previewImg = wrapper.querySelector('.testimonial-avatar-preview');
                                    if (previewImg) {
                                        previewImg.src = '../assets/images/defaults/avatar.png';
                                    }
                                    
                                    // Clear the hidden input
                                    const hiddenInput = wrapper.querySelector('.testimonial-avatar');
                                    if (hiddenInput) {
                                        hiddenInput.value = '';
                                    }
                                    
                                    // Reset file input
                                    const fileInput = wrapper.querySelector('.testimonial-avatar-input');
                                    if (fileInput) {
                                        fileInput.value = '';
                                    }
                                    
                                    // Remove has-avatar class
                                    wrapper.classList.remove('has-avatar');
                                }
                            });
                            
                            // Handle testimonial rating
                            document.addEventListener('click', function(e) {
                                if (e.target.matches('.rating-star')) {
                                    const rating = e.target.getAttribute('data-rating');
                                    const starsContainer = e.target.closest('.rating-selector');
                                    if (!starsContainer) return;
                                    
                                    // Update hidden input
                                    const ratingInput = starsContainer.querySelector('.testimonial-rating');
                                    if (ratingInput) {
                                        ratingInput.value = rating;
                                    }
                                    
                                    // Update stars appearance
                                    const stars = starsContainer.querySelectorAll('.rating-star');
                                    stars.forEach(star => {
                                        const starRating = star.getAttribute('data-rating');
                                        if (starRating <= rating) {
                                            star.classList.add('active');
                                        } else {
                                            star.classList.remove('active');
                                        }
                                    });
                                }
                            });
                            
                            /**
                             * Open the image crop modal
                             * @param {File} file - The image file to crop
                             * @param {HTMLImageElement} previewImg - The image element to update after cropping
                             * @param {Function} callback - Callback function with cropped image data
                             */
                            function openCropModal(file, previewImg, callback) {
                                const modalTemplate = document.querySelector('#image-crop-modal');
                                if (!modalTemplate) return;
                                
                                // Create modal
                                const modalContainer = document.getElementById('modal-container');
                                const modal = document.createElement('div');
                                modal.className = 'modal-wrapper';
                                modal.innerHTML = modalTemplate.innerHTML;
                                
                                modalContainer.appendChild(modal);
                                
                                // Get crop image element
                                const cropImage = modal.querySelector('#crop-image');
                                if (!cropImage) return;
                                
                                // Create a URL for the file
                                const imageUrl = URL.createObjectURL(file);
                                cropImage.src = imageUrl;
                                
                                // Initialize cropper after image is loaded
                                cropImage.onload = function() {
                                    // Initialize Cropper.js
                                    const cropper = new Cropper(cropImage, {
                                        aspectRatio: 1, // Square aspect ratio for avatars
                                        viewMode: 1,
                                        dragMode: 'move',
                                        autoCropArea: 0.8,
                                        preview: '#crop-preview',
                                        guides: true,
                                        center: true,
                                        minContainerWidth: 300,
                                        minContainerHeight: 300
                                    });
                                    
                                    // Handle crop controls
                                    modal.querySelector('.crop-zoom-in').addEventListener('click', function() {
                                        cropper.zoom(0.1);
                                    });
                                    
                                    modal.querySelector('.crop-zoom-out').addEventListener('click', function() {
                                        cropper.zoom(-0.1);
                                    });
                                    
                                    modal.querySelector('.crop-rotate').addEventListener('click', function() {
                                        cropper.rotate(90);
                                    });
                                    
                                    modal.querySelector('.crop-reset').addEventListener('click', function() {
                                        cropper.reset();
                                    });
                                    
                                    // Handle Apply button
                                    modal.querySelector('#apply-crop').addEventListener('click', function() {
                                        // Get cropped canvas and convert to base64
                                        const canvas = cropper.getCroppedCanvas({
                                            width: 100,
                                            height: 100,
                                            fillColor: '#fff'
                                        });
                                        
                                        const croppedImage = canvas.toDataURL('image/jpeg', 0.8);
                                        
                                        // Call the callback with the cropped image
                                        callback(croppedImage);
                                        
                                        // Close modal
                                        closeModal(modal);
                                        
                                        // Clean up
                                        URL.revokeObjectURL(imageUrl);
                                    });
                                };
                                
                                // Show modal with animation
                                setTimeout(() => {
                                    modal.classList.add('active');
                                }, 10);
                                
                                // Handle modal close
                                const closeButtons = modal.querySelectorAll('.modal-close');
                                closeButtons.forEach(button => {
                                    button.addEventListener('click', function() {
                                        closeModal(modal);
                                        URL.revokeObjectURL(imageUrl);
                                    });
                                });
                            }
                            
                            /**
                             * Close a modal
                             * @param {HTMLElement} modal - The modal to close
                             */
                            function closeModal(modal) {
                                modal.classList.remove('active');
                                
                                // Remove from DOM after animation
                                setTimeout(() => {
                                    if (modal.parentNode) {
                                        modal.parentNode.removeChild(modal);
                                    }
                                }, 300);
                            }
                            
                            // Toggle advanced options
                            document.addEventListener('click', function(e) {
                                if (e.target.closest('.advanced-toggle')) {
                                    const advancedOptions = e.target.closest('.advanced-options');
                                    if (!advancedOptions) return;
                                    
                                    const content = advancedOptions.querySelector('.advanced-content');
                                    const icon = advancedOptions.querySelector('.advanced-toggle i');
                                    
                                    if (content) {
                                        content.classList.toggle('hidden');
                                        
                                        if (icon) {
                                            if (content.classList.contains('hidden')) {
                                                icon.classList.remove('fa-chevron-up');
                                                icon.classList.add('fa-chevron-down');
                                            } else {
                                                icon.classList.remove('fa-chevron-down');
                                                icon.classList.add('fa-chevron-up');
                                            }
                                        }
                                    }
                                }
                            });
                            
                            // Toggle templates section
                            document.querySelector('.toggle-templates-btn')?.addEventListener('click', function() {
                                const container = document.querySelector('.templates-container');
                                const icon = this.querySelector('i');
                                
                                if (container && icon) {
                                    container.classList.toggle('hidden');
                                    
                                    if (container.classList.contains('hidden')) {
                                        icon.classList.remove('fa-chevron-up');
                                        icon.classList.add('fa-chevron-down');
                                        this.innerHTML = '<i class="fas fa-chevron-down"></i> Show Templates';
                                    } else {
                                        icon.classList.remove('fa-chevron-down');
                                        icon.classList.add('fa-chevron-up');
                                        this.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Templates';
                                    }
                                }
                            });
                            
                            // Use template buttons
                            document.querySelectorAll('.use-template-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const template = this.closest('.template-card').getAttribute('data-template');
                                    if (TestimonialsEditor) {
                                        TestimonialsEditor.addTemplateItem(template);
                                    }
                                });
                            });
                        });
                    </script>
                </body>
                </html>